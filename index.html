<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Plan - Loteamento Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #0f172a; overflow: hidden; }
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #f1f5f9; }
        #map { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; transition: transform 0.1s linear; }
        
        /* Estilo do Modo Projeto (Planta Técnica) */
        .project-mode #map { background: #ffffff !important; }
        .project-mode .leaflet-tile-pane { display: none; }
        .project-mode .leaflet-container { background: #fff !important; }
        
        .control-panel { z-index: 2000; }
        input[type="range"] { accent-color: #4f46e5; }
        .leaflet-control-container { transform: rotate(calc(var(--map-rot, 0) * -1deg)) !important; }
        
        /* Marcadores de Desenho */
        .custom-pin {
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: move;
        }
        .pin-start { background: #22c55e !important; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        .area-label {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #1e293b;
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: bold;
            font-size: 11px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            pointer-events: none;
        }

        /* Cotas e Numeração Técnica */
        .tech-label {
            text-align: center;
            pointer-events: none;
            border: none;
            box-shadow: none;
            background: transparent;
            white-space: nowrap;
        }
        .lot-number { font-size: 9px; font-weight: 900; color: #1e293b; }
        .lot-measure { font-size: 6px; color: #64748b; font-family: monospace; }
        .street-name { 
            font-size: 10px; 
            font-weight: 800; 
            color: #1e293b; 
            text-transform: uppercase; 
            background: rgba(255,255,255,0.8); 
            padding: 2px 6px; 
            border-radius: 2px;
            white-space: nowrap;
            display: inline-block;
        }

        /* Selo de Engenharia */
        #eng-stamp {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 300px;
            background: white;
            border: 2px solid #000;
            z-index: 2000;
            padding: 15px;
            display: none;
        }
        .project-mode #eng-stamp { display: block; }

        @media print {
            .control-panel { display: none !important; }
            #viewport { width: 100vw; height: 100vh; top: 0 !important; left: 0 !important; }
            #map { top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; transform: none !important; }
            .leaflet-control-container { display: none !important; }
        }
    </style>
</head>
<body class="text-slate-900 font-sans">

    <div class="flex flex-col lg:flex-row h-screen" id="main-container">
        <!-- Sidebar -->
        <div class="w-full lg:w-96 bg-white shadow-2xl z-[2000] control-panel flex flex-col border-r border-slate-200 overflow-y-auto print:hidden">
            
            <div class="flex border-b border-slate-100 sticky top-0 bg-white z-10">
                <button id="view-plan" class="flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-indigo-600 text-indigo-600 bg-indigo-50 transition-all">Vista Satélite</button>
                <button id="view-project" class="flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-transparent text-slate-400 hover:bg-slate-50 transition-all">Planta de Projeto</button>
            </div>

            <div class="p-5 space-y-6 flex-1">
                <!-- Visibilidade -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h2 class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-3 text-center">Controles de Visão</h2>
                    <div class="flex gap-2">
                        <button id="toggle-areas" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[10px] font-bold uppercase shadow-sm hover:bg-indigo-50 transition">Divisões</button>
                        <button id="toggle-pins" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-[10px] font-bold uppercase shadow-sm hover:bg-indigo-50 transition">Pins (E1..)</button>
                    </div>
                </div>

                <!-- Rotação Mapa -->
                <div id="sat-control" class="bg-slate-900 p-4 rounded-xl text-white shadow-lg transition-opacity">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Girar Satélite</h2>
                        <span id="mapRotValue" class="text-indigo-400 font-black">0°</span>
                    </div>
                    <input type="range" id="mapRotation" min="0" max="360" value="0" class="w-full cursor-pointer">
                </div>

                <!-- Áreas Familiares -->
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xs font-bold text-slate-800 uppercase tracking-widest">Territórios Demarcados</h2>
                        <button id="addAreaBtn" class="bg-indigo-600 text-white text-[10px] px-3 py-1.5 rounded-full font-bold uppercase shadow-md">+ Área</button>
                    </div>
                    <div id="activeAreaStatus" class="hidden bg-green-50 border border-green-200 p-3 rounded-lg border-dashed">
                        <p class="text-[10px] font-bold text-green-700 uppercase">Desenho Ativo</p>
                        <p class="text-[9px] text-green-600">Feche o polígono no <strong class="underline">ponto verde</strong>.</p>
                    </div>
                    <div id="areasList" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
                </div>

                <hr class="border-slate-100">

                <!-- Loteamento -->
                <div class="space-y-4">
                    <h2 class="text-xs font-bold text-slate-800 uppercase tracking-widest">Ajuste do Loteamento</h2>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-50 p-2.5 rounded border border-slate-200">
                            <label class="block text-[9px] font-bold text-slate-400 uppercase">Frente Lote (m)</label>
                            <input type="number" id="plotWidth" value="10" class="w-full bg-transparent font-bold text-sm outline-none">
                        </div>
                        <div class="bg-slate-50 p-2.5 rounded border border-slate-200">
                            <label class="block text-[9px] font-bold text-slate-400 uppercase">Fundo Lote (m)</label>
                            <input type="number" id="plotDepth" value="25" class="w-full bg-transparent font-bold text-sm outline-none">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[9px] font-bold text-slate-500 uppercase">Rotação da Planta</label>
                            <span id="projectRotValue" class="text-indigo-600 font-bold text-[10px]">0°</span>
                        </div>
                        <input type="range" id="projectRotation" min="0" max="360" value="0" class="w-full">
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-100 flex flex-col gap-2">
                <button id="printBtn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-[10px] uppercase shadow-lg hover:bg-indigo-700 transition">Imprimir Planta PDF</button>
                <button id="recenterBtn" class="w-full bg-slate-800 text-white py-2 rounded-lg font-bold text-[9px] uppercase">Reposicionar Âncora</button>
                <button id="clearDataBtn" class="w-full text-red-400 text-[8px] font-bold uppercase py-1">Resetar Dados</button>
            </div>
        </div>

        <!-- Viewport -->
        <div class="flex-1" id="viewport">
            <div id="map"></div>
            
            <!-- Selo Técnico Profissional -->
            <div id="eng-stamp" class="shadow-[0_0_0_2px_rgba(0,0,0,1)]">
                <div class="border-b-2 border-black pb-2 mb-3 text-center">
                    <h4 class="font-black text-lg uppercase tracking-tighter">Projeto de Parcelamento do Solo</h4>
                    <p class="text-[10px] font-bold">Ubajara/Tianguá - Ceará</p>
                </div>
                <div class="grid grid-cols-2 gap-y-3 text-[10px] uppercase font-black">
                    <div class="border-r border-black pr-2">PROPRIETÁRIO: <br><span class="font-normal text-slate-600">Vovó & Família</span></div>
                    <div class="pl-2 border-b border-black">DATA: <br><span class="font-normal text-slate-600">Jan / 2026</span></div>
                    <div class="border-r border-black pr-2">COORDENADAS: <br><span class="font-normal text-slate-600 text-[8px]">3°53'06"S 40°44'34"W</span></div>
                    <div class="pl-2">ÁREA TOTAL: <br><span id="total-project-area" class="font-normal text-slate-600">---</span></div>
                    <div class="col-span-2 border-t-2 border-black pt-2 text-center text-[11px]">
                        Loteamento: <span class="text-indigo-600">80 UNIDADES</span>
                    </div>
                </div>
            </div>

            <!-- Modal -->
            <div id="nameModal" class="hidden absolute inset-0 bg-black/60 z-[3000] flex items-center justify-center p-4">
                <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-sm border-t-8 border-indigo-600">
                    <h3 class="font-black text-xl mb-6 text-center">Demarcar Lote Familiar</h3>
                    <div class="space-y-4">
                        <input type="text" id="propName" placeholder="Identificação (Ex: Vovó, Filho 1)" class="w-full border-2 border-slate-100 rounded-xl p-4 text-sm outline-none focus:border-indigo-600">
                        <div class="flex gap-2 justify-center flex-wrap">
                            <button class="color-opt w-9 h-9 rounded-full bg-red-500 border-2 border-white" data-color="#ef4444"></button>
                            <button class="color-opt w-9 h-9 rounded-full bg-blue-500 border-2 border-white" data-color="#3b82f6"></button>
                            <button class="color-opt w-9 h-9 rounded-full bg-green-500 border-2 border-white" data-color="#22c55e"></button>
                            <button class="color-opt w-9 h-9 rounded-full bg-yellow-500 border-2 border-white" data-color="#eab308"></button>
                            <button class="color-opt w-9 h-9 rounded-full bg-orange-500 border-2 border-white" data-color="#f97316"></button>
                            <button class="color-opt w-9 h-9 rounded-full bg-purple-500 border-2 border-white" data-color="#a855f7"></button>
                        </div>
                        <button id="saveAreaBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-xs">Começar Desenho</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const initialLat = -3.885028;
        const initialLng = -40.742972;

        const map = L.map('map', { zoomControl: false, maxZoom: 21, attributionControl: false }).setView([initialLat, initialLng], 18);
        const satLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 21 }).addTo(map);

        const areasLayer = L.layerGroup().addTo(map);
        const gridLayer = L.layerGroup().addTo(map);
        const labelsLayer = L.layerGroup().addTo(map);
        const pinsLayer = L.layerGroup().addTo(map);
        const techLabelsLayer = L.layerGroup().addTo(map);
        const anchor = L.marker([initialLat, initialLng], { draggable: true }).addTo(map);

        let areas = [];
        let drawingArea = null;
        let selectedColor = "#ef4444";
        let globalPinCount = 1;
        let isProjectMode = false;

        const el = {
            mapRotation: document.getElementById('mapRotation'),
            projectRotation: document.getElementById('projectRotation'),
            plotWidth: document.getElementById('plotWidth'),
            plotDepth: document.getElementById('plotDepth'),
            areasList: document.getElementById('areasList')
        };

        // --- TROCA DE MODOS ---
        document.getElementById('view-plan').onclick = () => switchMode(false);
        document.getElementById('view-project').onclick = () => switchMode(true);
        
        document.getElementById('printBtn').onclick = () => {
            // Tenta abrir o diálogo de impressão de forma mais agressiva
            window.focus();
            window.print();
        };

        function switchMode(project) {
            isProjectMode = project;
            document.getElementById('main-container').classList.toggle('project-mode', project);
            document.getElementById('sat-control').classList.toggle('opacity-30', project);
            
            document.getElementById('view-project').className = project ? "flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-slate-800 text-slate-800 bg-slate-50" : "flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-transparent text-slate-400 hover:bg-slate-50";
            document.getElementById('view-plan').className = !project ? "flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-indigo-600 text-indigo-600 bg-indigo-50" : "flex-1 py-4 text-xs font-black uppercase tracking-widest border-b-4 border-transparent text-slate-400 hover:bg-slate-50";
            
            drawGrid();
        }

        // --- VISIBILIDADE ---
        document.getElementById('toggle-areas').onclick = function() {
            if (map.hasLayer(areasLayer)) { map.removeLayer(areasLayer); map.removeLayer(labelsLayer); this.classList.add('bg-slate-800', 'text-white'); }
            else { map.addLayer(areasLayer); map.addLayer(labelsLayer); this.classList.remove('bg-slate-800', 'text-white'); }
        };

        document.getElementById('toggle-pins').onclick = function() {
            if (map.hasLayer(pinsLayer)) { map.removeLayer(pinsLayer); this.classList.add('bg-slate-800', 'text-white'); }
            else { map.addLayer(pinsLayer); this.classList.remove('bg-slate-800', 'text-white'); }
        };

        // --- PERSISTÊNCIA ---
        function saveToStorage() {
            const data = {
                areas: areas.map(a => ({ id: a.id, name: a.name, color: a.color, points: a.markers.map(m => m.getLatLng()) })),
                settings: { mapRotation: el.mapRotation.value, projectRotation: el.projectRotation.value, plotWidth: el.plotWidth.value, plotDepth: el.plotDepth.value, anchor: anchor.getLatLng(), pinCount: globalPinCount }
            };
            localStorage.setItem('loteamento_v7', JSON.stringify(data));
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('loteamento_v7');
            if (!stored) return;
            const data = JSON.parse(stored);
            el.mapRotation.value = data.settings.mapRotation || 0;
            el.projectRotation.value = data.settings.projectRotation || 0;
            el.plotWidth.value = data.settings.plotWidth || 10;
            el.plotDepth.value = data.settings.plotDepth || 25;
            globalPinCount = data.settings.pinCount || 1;
            anchor.setLatLng(data.settings.anchor);
            
            updateMapRotation();
            data.areas.forEach(a => {
                const markers = a.points.map((p, idx) => createMarker(p, idx === 0, globalPinCount++));
                const areaData = { id: a.id, name: a.name, color: a.color, markers: markers, polygon: L.polygon(a.points, { color: a.color, fillColor: a.color, fillOpacity: 0.3, weight: 3 }).addTo(areasLayer), label: null };
                areaData.markers.forEach(m => { m.on('drag', () => updateExistingArea(areaData)); m.on('dragend', handleSnapping); });
                areas.push(areaData);
                updateExistingArea(areaData);
            });
            drawGrid();
            renderAreasList();
        }

        // --- DESENHO ---
        function createMarker(latlng, isFirst, count) {
            const m = L.marker(latlng, { draggable: true, icon: L.divIcon({ className: isFirst ? 'custom-pin pin-start' : 'custom-pin', html: `E${count}`, iconSize: [22, 22] }) }).addTo(pinsLayer);
            return m;
        }

        function getCorrectedLatLng(e) {
            const rot = parseFloat(el.mapRotation.value);
            const r = map.getContainer().getBoundingClientRect();
            const cx = e.containerPoint.x - r.width / 2, cy = e.containerPoint.y - r.height / 2;
            const a = -rot * (Math.PI / 180);
            const nx = cx * Math.cos(a) - cy * Math.sin(a), ny = cx * Math.sin(a) + cy * Math.cos(a);
            return map.containerPointToLatLng(L.point(nx + r.width / 2, ny + r.height / 2));
        }

        document.getElementById('addAreaBtn').onclick = () => document.getElementById('nameModal').classList.remove('hidden');
        document.querySelectorAll('.color-opt').forEach(btn => btn.onclick = function() {
            selectedColor = this.dataset.color;
            document.querySelectorAll('.color-opt').forEach(b => b.classList.remove('ring-4', 'ring-indigo-300'));
            this.classList.add('ring-4', 'ring-indigo-300');
        });

        document.getElementById('saveAreaBtn').onclick = () => {
            drawingArea = { name: document.getElementById('propName').value || "Terreno", color: selectedColor, markers: [], line: L.polyline([], { color: selectedColor, weight: 3, dashArray: '5, 10' }).addTo(areasLayer) };
            document.getElementById('nameModal').classList.add('hidden');
            document.getElementById('activeAreaStatus').classList.remove('hidden');
        };

        map.on('click', (e) => {
            if (!drawingArea) return;
            const ll = getCorrectedLatLng(e), isF = drawingArea.markers.length === 0;
            const m = createMarker(ll, isF, globalPinCount++);
            if (isF) m.on('click', (ev) => { L.DomEvent.stopPropagation(ev); if (drawingArea.markers.length > 2) finishArea(); });
            m.on('drag', () => drawingArea.line.setLatLngs(drawingArea.markers.map(x => x.getLatLng())));
            drawingArea.markers.push(m);
            drawingArea.line.setLatLngs(drawingArea.markers.map(x => x.getLatLng()));
        });

        function calculateAreaM2(latlngs) {
            if (latlngs.length < 3) return 0;
            let area = 0; const R = 6378137;
            for (let i = 0; i < latlngs.length; i++) {
                const p1 = latlngs[i], p2 = latlngs[(i + 1) % latlngs.length];
                area += (p2.lng - p1.lng) * (Math.PI / 180) * (2 + Math.sin(p1.lat * (Math.PI / 180)) + Math.sin(p2.lat * (Math.PI / 180)));
            }
            return Math.abs(area * R * R / 2);
        }

        function updateExistingArea(area) {
            const pts = area.markers.map(m => m.getLatLng());
            area.polygon.setLatLngs(pts);
            const val = calculateAreaM2(pts);
            if (area.label) labelsLayer.removeLayer(area.label);
            area.label = L.marker(area.polygon.getBounds().getCenter(), { icon: L.divIcon({ className: 'area-label', html: `<b>${area.name}</b><br>${(val/10000).toLocaleString('pt-BR', {maximumFractionDigits:3})} ha` }) }).addTo(labelsLayer);
            saveToStorage();
        }

        function handleSnapping(e) {
            const all = [...(drawingArea?drawingArea.markers:[]), ...areas.flatMap(a=>a.markers)];
            for (let m of all) {
                if (m === e.target) continue;
                if (map.distance(e.target.getLatLng(), m.getLatLng()) < 4) { e.target.setLatLng(m.getLatLng()); break; }
            }
            areas.forEach(updateExistingArea);
        }

        function finishArea() {
            areasLayer.removeLayer(drawingArea.line);
            const areaData = { id: Date.now(), name: drawingArea.name, color: drawingArea.color, markers: drawingArea.markers, polygon: L.polygon(drawingArea.markers.map(m=>m.getLatLng()), { color: drawingArea.color, fillColor: drawingArea.color, fillOpacity: 0.3, weight: 3 }).addTo(areasLayer), label: null };
            areaData.markers.forEach(m => { m.on('drag', () => updateExistingArea(areaData)); m.on('dragend', handleSnapping); });
            areas.push(areaData);
            updateExistingArea(areaData);
            drawingArea = null;
            document.getElementById('activeAreaStatus').classList.add('hidden');
            renderAreasList();
        }

        function renderAreasList() {
            el.areasList.innerHTML = areas.length ? '' : '<p class="text-[10px] text-slate-400 italic text-center py-4">Nenhuma área demarcada.</p>';
            areas.forEach(a => {
                const d = document.createElement('div');
                d.className = "p-3 bg-white rounded-xl border border-slate-100 flex items-center justify-between text-[11px] shadow-sm";
                d.innerHTML = `<div class="flex items-center gap-2"><div class="w-2.5 h-2.5 rounded-full" style="background:${a.color}"></div><b>${a.name}</b></div><button class="text-red-400 font-bold hover:text-red-600" onclick="removeArea(${a.id})">APAGAR</button>`;
                el.areasList.appendChild(d);
            });
        }

        window.removeArea = (id) => {
            const a = areas.find(x => x.id === id);
            if (a) {
                areasLayer.removeLayer(a.polygon);
                a.markers.forEach(m => pinsLayer.removeLayer(m));
                if (a.label) labelsLayer.removeLayer(a.label);
                areas = areas.filter(x => x.id !== id);
                renderAreasList();
                saveToStorage();
            }
        };

        // --- ROTAÇÃO E GRADE ---
        function updateMapRotation() {
            const d = el.mapRotation.value;
            document.getElementById('map').style.transform = `rotate(${d}deg)`;
            document.getElementById('mapRotValue').innerText = d + "°";
            document.documentElement.style.setProperty('--map-rot', d);
            saveToStorage();
        }

        function drawGrid() {
            gridLayer.clearLayers();
            techLabelsLayer.clearLayers();
            
            const pos = anchor.getLatLng();
            const pw = parseFloat(el.plotWidth.value);
            const pd = parseFloat(el.plotDepth.value);
            const rot = parseFloat(el.projectRotation.value) * (Math.PI / 180);
            document.getElementById('projectRotValue').innerText = el.projectRotation.value + "°";
            
            const scale = { lat: 1 / 111320, lng: 1 / (111320 * Math.cos(pos.lat * Math.PI / 180)) };
            
            const sw = 10; // Rua interna
            const sideStreetL = isProjectMode ? 10 : 0; // Rua Lateral Esquerda (10m) - RUA DE LIMITE
            const sideStreetR = isProjectMode ? 20 : 0; // Rua Lateral Direita (20m) - AVENIDA PRINCIPAL
            const nB = 4; 
            const lPS = 10; 
            
            const tw = lPS * pw; 
            const th = (nB * (pd * 2)) + ((nB - 1) * sw); 

            // --- Lógica de Ruas do Projeto Técnico ---
            if (isProjectMode) {
                // Rua de Limite (LADO ESQUERDO - 10m)
                const cSideL = [{x: -sideStreetL, y: 0}, {x: 0, y: 0}, {x: 0, y: th}, {x: -sideStreetL, y: th}];
                L.polygon(cSideL.map(p => rotatePoint(p.x, p.y, tw, th, rot, pos, scale)), { color: '#000', weight: 1, fillColor: '#f1f5f9', fillOpacity: 1 }).addTo(gridLayer);
                addTechLabel("RUA DE LIMITE (10m)", {x: -sideStreetL/2, y: th/2}, rot, pos, scale, 'street-name', true);

                // Avenida Principal (LADO DIREITO - 20m)
                const cSideR = [{x: tw, y: 0}, {x: tw + sideStreetR, y: 0}, {x: tw + sideStreetR, y: th}, {x: tw, y: th}];
                L.polygon(cSideR.map(p => rotatePoint(p.x, p.y, tw, th, rot, pos, scale)), { color: '#000', weight: 1, fillColor: '#334155', fillOpacity: 1 }).addTo(gridLayer);
                addTechLabel("AVENIDA PRINCIPAL (20m)", {x: tw + sideStreetR/2, y: th/2}, rot, pos, scale, 'street-name', true);

                // Rua de Fundo (10m)
                const cBack = [{x: -sideStreetL, y: th}, {x: tw + sideStreetR, y: th}, {x: tw + sideStreetR, y: th + 10}, {x: -sideStreetL, y: th + 10}];
                L.polygon(cBack.map(p => rotatePoint(p.x, p.y, tw, th, rot, pos, scale)), { color: '#000', weight: 1, fillColor: '#e2e8f0', fillOpacity: 1 }).addTo(gridLayer);
                addTechLabel("VIA DE ACESSO FUNDO (10m)", {x: tw/2, y: th + 5}, rot, pos, scale, 'street-name', false);
            }

            // --- Blocos de Lotes ---
            let lotCounter = 1;

            for (let b = 0; b < nB; b++) {
                let blockY = b * (pd * 2 + sw);

                // Ruas Internas
                if (b < nB - 1 && isProjectMode) {
                    let ry = (b + 1) * (pd * 2) + b * sw;
                    const cr = [{x:0, y:ry}, {x:tw, y:ry}, {x:tw, y:ry+sw}, {x:0, y:ry+sw}];
                    L.polygon(cr.map(p => rotatePoint(p.x, p.y, tw, th, rot, pos, scale)), { color: '#64748b', weight: 0.5, fillColor: '#f8fafc', fillOpacity: 1 }).addTo(gridLayer);
                    addTechLabel("RUA " + (b + 1) + " (10m)", {x: tw/2, y: ry + sw/2}, rot, pos, scale, 'street-name', false);
                }

                for (let s = 0; s < 2; s++) { 
                    for (let l = 0; l < lPS; l++) {
                        let ox = l * pw;
                        let oy = (b * (pd * 2 + sw)) + (s * pd);
                        const c = [{x:ox,y:oy},{x:ox+pw,y:oy},{x:ox+pw,y:oy+pd},{x:ox,y:oy+pd}];
                        
                        L.polygon(c.map(p => rotatePoint(p.x, p.y, tw, th, rot, pos, scale)), { 
                            color: isProjectMode ? '#000' : '#4f46e5', 
                            weight: isProjectMode ? 0.5 : 1.2, 
                            fillColor: isProjectMode ? '#fff' : '#818cf8', 
                            fillOpacity: isProjectMode ? 0 : 0.25, 
                            interactive: false 
                        }).addTo(gridLayer);

                        if (isProjectMode) {
                            const num = String(lotCounter++).padStart(2, '0');
                            addTechLabel(num, {x: ox + pw/2, y: oy + pd/2 + 2}, rot, pos, scale, 'lot-number', false);
                            addTechLabel(pw + "x" + pd, {x: ox + pw/2, y: oy + pd/2 - 5}, rot, pos, scale, 'lot-measure', false);
                        }
                    }
                }
            }

            const th_total = (nB * (pd * 2)) + ((nB - 1) * sw);
            const totalArea = (tw * th_total) + (isProjectMode ? (sideStreetL + sideStreetR) * th_total + (tw + sideStreetL + sideStreetR) * 10 : 0);
            document.getElementById('total-project-area').innerText = totalArea.toLocaleString('pt-BR') + " m²";

            saveToStorage();
        }

        function addTechLabel(text, offset, angle, anchor, scale, className, isVertical = false) {
            const tw = (10 * parseFloat(el.plotWidth.value));
            const th = (4 * parseFloat(el.plotDepth.value) * 2 + 30);
            const pt = rotatePoint(offset.x, offset.y, tw, th, angle, anchor, scale);
            
            // Se for vertical, rotacionamos o texto 90 graus extras
            const extraRot = isVertical ? (90 * Math.PI / 180) : 0;
            
            L.marker(pt, {
                icon: L.divIcon({
                    className: 'tech-label',
                    html: `<div class="${className}" style="transform: rotate(${angle + extraRot}rad)">${text}</div>`
                })
            }).addTo(techLabelsLayer);
        }

        function rotatePoint(x, y, tw, th, angle, anchor, scale) {
            const rx = x - tw / 2, ry = y - th / 2;
            const nx = rx * Math.cos(angle) - ry * Math.sin(angle), ny = rx * Math.sin(angle) + ry * Math.cos(angle);
            return [anchor.lat + ny * scale.lat, anchor.lng + nx * scale.lng];
        }

        el.mapRotation.oninput = updateMapRotation;
        ['plotWidth', 'plotDepth', 'projectRotation'].forEach(id => document.getElementById(id).oninput = drawGrid);
        anchor.on('drag', drawGrid);
        document.getElementById('recenterBtn').onclick = () => { anchor.setLatLng(map.getCenter()); drawGrid(); };
        document.getElementById('clearDataBtn').onclick = () => { if(confirm("Apagar todos os dados?")) { localStorage.clear(); location.reload(); } };

        window.onload = () => { loadFromStorage(); setTimeout(drawGrid, 500); };
    </script>
</body>
</html>
